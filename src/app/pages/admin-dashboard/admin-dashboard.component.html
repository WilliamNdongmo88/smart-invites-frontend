<div class="admin-layout">
  <!-- Sidebar √† gauche -->
  <aside *ngIf="!(isMobile | async)" class="admin-sidebar">
    <div class="sidebar-header">
      <h3>Admin Panel</h3>
    </div>
    <nav class="sidebar-nav">
      <button 
        *ngFor="let tab of tabs" 
        [class.active]="activeTab === tab.id"
        (click)="activeTab = tab.id; currentPage = 1"
        class="nav-item"
      >
        <span class="nav-label">{{ tab.label }}</span>
      </button>
    </nav>
  </aside>

  <!-- Contenu principal √† droite -->
  <main class="admin-main">
    <!-- Header -->
    <div class="admin-header">
    <div class="container">
        <a routerLink="/evenements" class="back-link">‚Üê Retour</a>
        <h1>Panneau d'Administration</h1>
        <p>Gestion compl√®te de la plateforme</p>
    </div>
    </div>

    <!-- Navigation Tabs -->
    <div *ngIf="isMobile | async" class="admin-tabs">
        <button
        *ngFor="let tab of tabs"
        [class.active]="activeTab === tab.id"
        (click)="activeTab = tab.id"
        class="tab-btn"
        >
        {{ tab.label }}
        </button>
    </div>

    <!-- TAB: FEEDBACK -->
    <div *ngIf="activeTab === 'feedback'" class="tab-content">
      <div class="section-card">
        <h2>Retours d'Impression</h2>
        
        <div class="filters">
          <input type="text" [(ngModel)]="feedbackSearch" placeholder="Rechercher..." class="form-input" (ngModelChange)="currentPage = 1">
        </div>

        <div class="list-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>Email</th>
                <th>Note</th>
                <th>Titre</th>
                <th>Statut</th>
                <th>Date</th>
              </tr>
            </thead>
            <tbody>
                <tr *ngFor="let feedback of getPaginatedData(getFilteredFeedback())" class="feedback-row">
                    <td
                        class="email-cell"
                        [ngClass]="feedback.isSubscriber">
                        {{ feedback.email }}
                    </td>
                    <td>
                        <div class="rating-display">
                        <span *ngFor="let i of [1,2,3,4,5]" class="star" [class.filled]="i <= feedback.rating">‚òÖ</span>
                        </div>
                    </td>
                    <td>{{ feedback.title }}</td>
                    <td>{{ feedback.category }}</td>
                    <td>
                        <select [(ngModel)]="feedback.status" class="status-select" 
                        [ngClass]="feedback.status" (change)="updateFeedbackStatus(feedback)">
                        <option value="pending">En attente</option>
                        <option value="reviewed">Examin√©</option>
                        <option value="resolved">R√©solu</option>
                        </select>
                    </td>
                    <td>{{ formatDate(feedback.createdAt) }}</td>
                    <td>
                        <button class="btn-small btn-view" (click)="viewFeedbackDetails(feedback)">
                        üëÅÔ∏è Voir
                        </button>
                    </td>
                </tr>
            </tbody>
          </table>

          <!-- Feedback Details Modal -->
          <div *ngIf="selectedFeedback" class="modal-overlay" (click)="selectedFeedback = null">
            <div class="modal-content" (click)="$event.stopPropagation()">
                <button class="modal-close" (click)="selectedFeedback = null">‚úï</button>
                <h3>{{ selectedFeedback.title }}</h3>
                <p class="feedback-message">{{ selectedFeedback.message }}</p>
                <div class="modal-actions">
                        <textarea
                        [(ngModel)]="selectedFeedback.adminNotes"
                        placeholder="Ajouter une note interne..."
                        class="form-textarea"
                        ></textarea>
                        <button class="btn btn-primary" (click)="saveFeedbackNotes()">
                        üíæ Enregistrer les notes
                        </button>
                </div>
            </div>
          </div>
        </div>

        <!-- Pagination Controls -->
        <div class="pagination" *ngIf="getFilteredFeedback().length > pageSize">
          <button [disabled]="currentPage === 1" (click)="changePage(currentPage - 1)">Pr√©c√©dent</button>
          <span>Page {{ currentPage }} sur {{ getTotalPages(getFilteredFeedback()) }}</span>
          <button [disabled]="currentPage === getTotalPages(getFilteredFeedback())" (click)="changePage(currentPage + 1)">Suivant</button>
        </div>
      </div>
    </div>

    <!-- TAB 2: VISITORS -->
    <div *ngIf="activeTab === 'visitors'" class="tab-content">
        <div class="section-card">
        <h2>Visiteurs du Site</h2>

        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-box">
            <span class="stat-label">Total des visites</span>
            <span class="stat-value">{{ visitors.length }}</span>
            </div>
            <div class="stat-box">
            <span class="stat-label">Pays uniques</span>
            <span class="stat-value">{{ getUniqueCountries().length }}</span>
            </div>
            <div class="stat-box">
            <span class="stat-label">Appareils uniques</span>
            <span class="stat-value">{{ getUniqueDevices().length }}</span>
            </div>
            <div class="stat-box">
            <span class="stat-label">Navigateurs uniques</span>
            <span class="stat-value">{{ getUniqueBrowsers().length }}</span>
            </div>
        </div>

        <!-- Filters -->
        <div class="filters">
            <input
            type="text"
            [(ngModel)]="visitorSearch"
            placeholder="Rechercher par pays, ville ou IP..."
            class="form-input"
            />
        </div>

        <!-- Visitors List -->
        <div class="list-container">
            <table class="data-table">
            <thead>
                <tr>
                <th>IP</th>
                <th>Pays/Ville</th>
                <th>Appareil</th>
                <th>Navigateur</th>
                <th>Page visit√©e</th>
                <th>Dur√©e</th>
                <th>Date</th>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let visitor of getPaginatedData(getFilteredVisitors())" >
                <td class="mono">{{ visitor.ipAddress }}</td>
                <td>{{ visitor.country }} / {{ visitor.city }}</td>
                <td>{{ visitor.device }}</td>
                <td>{{ visitor.browser }}</td>
                <td>{{ visitor.pageVisited }}</td>
                <td>{{ formatDuration(visitor.duration) }}</td>
                <td>{{ formatDate(visitor.visitDate) }}</td>
                </tr>
            </tbody>
            </table>
        </div>
        </div>
    </div>

    <!-- TAB 3: USERS -->
    <div *ngIf="activeTab === 'users'" class="tab-content">
        <div class="section-card">
        <h2>Utilisateurs de la Plateforme</h2>

        <!-- Filters -->
        <div class="filters">
            <input
            type="text"
            [(ngModel)]="userSearch"
            placeholder="Rechercher par nom ou email..."
            class="form-input"
            />
            <select [(ngModel)]="userPlanFilter" class="form-select">
            <option value="">Tous les forfaits</option>
            <option value="gratuit">Gratuit</option>
            <option value="professionnel">Professionnel</option>
            <option value="entreprise">Entreprise</option>
            </select>
        </div>

        <!-- Users List -->
        <div class="list-container">
            <table class="data-table">
            <thead>
                <tr>
                <th>Nom</th>
                <th>Email</th>
                <th>√âv√©nements</th>
                <th>Forfait</th>
                <th>Preuve de payment</th>
                <!-- <th>Derni√®re connexion</th>
                <th>Cr√©√© le</th> -->
                <th>Statut</th>
                <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let user of getFilteredUsers()" [class.blocked]="user.isBlocked">
                <td>{{ user.name }}</td>
                <td>{{ user.email }}</td>
                <td>
                    <span class="status-badge">
                        {{ user.eventsCreated }}
                    </span>
                </td>
                <td>
                    <span class="plan-badge" [class]="user.plan">{{ user.plan }}</span>
                </td>
                <td>
                    <span *ngIf="!user.userPaymentProof" class="status-badge">
                        -
                    </span>
                    <span *ngIf="user.userPaymentProof" class="status-badge">
                        <button class="btn-small btn-view" (click)="viewPaymentProof(user)">
                        üëÅÔ∏è Voir
                        </button>
                    </span>
                </td>
                <td>
                    <span class="status-badge" [class]="user.isBlocked ? 'blocked' : 'active'">
                    {{ user.isBlocked ? 'Bloqu√©' : 'Actif' }}
                    </span>
                </td>
                <td>
                    <button class="btn-small btn-view" (click)="viewUserDetails(user)">
                    üëÅÔ∏è D√©tails
                    </button>
                    <button class="btn-small btn-view" (click)="viewUserEvents(user)">
                    üëÅÔ∏è √âv√©nements
                    </button>
                    <button class="btn-small btn-danger" (click)="toggleBlockUser(user)">
                    {{ user.isBlocked ? 'üîì D√©bloquer' : 'üîí Bloquer' }}
                    </button>
                    <button class="btn-small btn-danger" (click)="deleteUser(user)">
                    üóëÔ∏è Supprimer
                    </button>
                </td>
                </tr>
            </tbody>
            </table>
        </div>
        </div>

        <!-- Payment Proof Modal -->
        <div *ngIf="selectedPaymentProof" class="modal-overlay" (click)="closeModal()">

        <div class="modal-card" (click)="$event.stopPropagation()">

            <!-- Header -->
            <div class="modal-header">
            <div>
                <h2>Preuve de paiement</h2>
                <p class="subtitle">
                Utilisateur : <strong>{{ selectedPaymentProof.name }}</strong>
                </p>
                <p class="subtitle">
                Date expiration : <strong>{{ selectedPaymentProof.expirationDate }}</strong>
                </p>
            </div>

            <button class="close-btn" (click)="closeModal()">‚úï</button>
            </div>

            <!-- Image Preview -->
            <div class="image-container">
            <img 
                [src]="selectedPaymentProof.userPaymentProof" 
                alt="Preuve de paiement"
            />
            </div>

            <!-- Actions -->
            <div class="modal-actions">
            <button class="btn btn-approve" (click)="changeUserPlan(selectedPaymentProof, true)">
                ‚úîÔ∏è Valider le paiement
            </button>

            <button class="btn btn-cancel" (click)="changeUserPlan(selectedPaymentProof, false)">
                ‚ùå Annuler le plan Pro
            </button>
            </div>

        </div>
        </div>

        <!-- User Events Detail -->
        <div *ngIf="selectedUser" class="section-card detail-card">
        <h3>√âv√©nements de {{ selectedUser.name }}</h3>
        <button class="btn-close" (click)="selectedUser = null">‚úï Fermer</button>

        <div class="list-container">
            <table class="data-table">
            <thead>
                <tr>
                <th>Titre</th>
                <th>Type</th>
                <th>Invit√©s</th>
                <th>√âtape</th>
                <th>Date/Heure</th>
                <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let event of getPaginatedData(selectedUserEvents)" class="event-row">
                <td>{{ event.title }}</td>
                <td>{{ event.type }}</td>
                <td>
                    <span class="guest-count">{{ event.guestCount }}</span>
                    <span class="guest-status">
                    ‚úì {{ event.confirmedGuests }} | ‚è≥ {{ event.pendingGuests }} | ‚úï {{ event.declinedGuests }}
                    </span>
                </td>
                <td>
                    <span class="stage-badge" [class]="event.stage">{{ event.stage }}</span>
                </td>
                <td>{{ event.date }} {{ event.time }}</td>
                <td>
                    <button class="btn-small btn-view" (click)="viewEventGuests(event)">
                    üë• Invit√©s
                    </button>
                    <button class="btn-small btn-danger" (click)="deleteEvent(event)">
                    üóëÔ∏è Supprimer
                    </button>
                </td>
                </tr>
            </tbody>
            </table>
        </div>
        </div>
    </div>

    <!-- TAB 4: EVENT GUESTS -->
    <div *ngIf="activeTab === 'guests'" class="tab-content">
        <div *ngIf="selectedEvent" class="section-card">
        <h3>Invit√©s de l'√©v√©nement: {{ selectedEvent.title }}</h3>
        <button class="btn-close" (click)="selectedEvent = null; selectedEventGuests = []">‚úï Fermer</button>

        <!-- Guest Filters -->
        <div class="filters">
            <select [(ngModel)]="guestStatusFilter" class="form-select">
            <option value="">Tous les statuts</option>
            <option value="confirmed">Confirm√©s</option>
            <option value="pending">En attente</option>
            <option value="declined">Refus√©s</option>
            </select>
        </div>

        <!-- Guests List -->
        <div class="list-container">
            <table class="data-table">
            <thead>
                <tr>
                <th>
                    <input type="checkbox" (change)="toggleSelectAllGuests($event)" />
                </th>
                <th>Nom</th>
                <th>Email</th>
                <th>Statut</th>
                <th>QR Code</th>
                <th>Restrictions</th>
                <th>+1</th>
                <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let guest of getPaginatedData(getFilteredEventGuests())">
                <td>
                    <input type="checkbox" [(ngModel)]="guest.selected" />
                </td>
                <td>{{ guest.name }}</td>
                <td>{{ guest.email }}</td>
                <td>
                    <span class="status-badge" [class]="guest.status">{{ guest.status }}</span>
                </td>
                <td>
                    <span *ngIf="guest.qrCodeGenerated" class="qr-badge">‚úì G√©n√©r√©</span>
                    <span *ngIf="!guest.qrCodeGenerated" class="qr-badge not-generated">‚úï Non g√©n√©r√©</span>
                </td>
                <td>{{ guest.dietaryRestrictions || '-' }}</td>
                <td>{{ guest.plusOne ? '‚úì' : '-' }}</td>
                <td>
                    <button *ngIf="guest.qrCodeGenerated" class="btn-small btn-view" (click)="viewQRCode(guest)">
                    üì± QR Code
                    </button>
                    <button class="btn-small btn-danger" (click)="deleteGuest(guest)">
                    üóëÔ∏è Supprimer
                    </button>
                </td>
                </tr>
            </tbody>
            </table>
        </div>

        <!-- Bulk Actions -->
        <div class="bulk-actions">
            <button class="btn btn-danger" (click)="deleteSelectedGuests()">
            üóëÔ∏è Supprimer les invit√©s s√©lectionn√©s
            </button>
            <button class="btn btn-danger" (click)="deleteSelectedQRCodes()">
            üì± Supprimer les QR Codes s√©lectionn√©s
            </button>
        </div>
        </div>

        <!-- QR Code Viewer Modal -->
        <div *ngIf="selectedGuest && selectedGuest.qrCodeUrl" class="modal-overlay" (click)="selectedGuest = null">
        <div class="modal-content qr-modal" (click)="$event.stopPropagation()">
            <button class="modal-close" (click)="selectedGuest = null">‚úï</button>
            <h3>QR Code de {{ selectedGuest.name }}</h3>
            <img [src]="selectedGuest.qrCodeUrl" alt="QR Code" class="qr-image" />
            <div class="modal-actions">
            <a [href]="selectedGuest.qrCodeUrl" download class="btn btn-primary">
                üì• T√©l√©charger
            </a>
            <button class="btn btn-danger" (click)="deleteQRCode(selectedGuest)">
                üóëÔ∏è Supprimer le QR Code
            </button>
            </div>
        </div>
        </div>
    </div>
    
    <!-- TAB: MAINTENANCE -->
    <div *ngIf="activeTab === 'maintenance'" class="tab-content">

    <!-- G√©rer la Maintenance -->
    <div class="section-card">
        <h2>G√©rer la Maintenance</h2>
        <div class="maintenance-form">
        <div class="form-group">
            <label>Statut</label>
            <select [(ngModel)]="maintenance.status" class="form-select">
            <option value="disabled">D√©sactiv√©e</option>
            <option value="enabled">Activ√©e</option>
            </select>
        </div>
        <div class="form-group">
            <label>Progression : {{ maintenance.maintenance_progress }}%</label>
            <input type="range" [(ngModel)]="maintenance.maintenance_progress" min="0" max="100" class="form-range">
        </div>
        <button class="btn btn-primary" (click)="saveMaintenance()">{{ loading ? '‚è≥ En cours...' : 'Enregistrer' }}</button>
        </div>
    </div>

    <!-- Actions Rapides -->
    <div class="section-card">
        <h2>Actions Rapides</h2>
        <div class="quick-actions">
        <button class="btn btn-secondary" (click)="restartScheduler()">
            {{ loading ? '‚è≥ Relance...' : 'üîÑ Relancer le Schedule des √âv√©nements' }}
        </button>
        <button class="btn btn-info" (click)="clearCache()">
            {{ loading ? '‚è≥ En cours...' : 'üßπ Vider le Cache de l\'Application' }}
        </button>
        </div>
    </div>

    <!-- Notifications Utilisateurs -->
    <div class="section-card">
        <h2>Notifier les Utilisateurs</h2>
        <div class="notification-form">
        <div class="form-group">
            <label>Titre de la Notification</label>
            <input type="text" [(ngModel)]="notification.title" class="form-control form-input" placeholder="Ex: Nouvelle fonctionnalit√© !">
        </div>
        <div class="form-group">
            <label>Message</label>
            <textarea [(ngModel)]="notification.message" class="form-control form-input" rows="3" placeholder="D√©crivez ici les nouveaut√©s..."></textarea>
        </div>
        <button class="btn btn-success" (click)="sendNotification()">
            <i class="fas fa-paper-plane"></i> Envoyer la Notification
        </button>
        </div>
    </div>

    <!-- Export de Donn√©es -->
    <div class="section-card">
        <h2>Export de Donn√©es</h2>
        <div class="export-actions">
            <div class="form-group">
                <label>Type de donn√©es √† exporter</label>
                <select [(ngModel)]="exportType" class="form-select">
                    <option value="users">Utilisateurs</option>
                    <option value="events">√âv√©nements</option>
                    <option value="logs">Logs d'activit√©</option>
                </select>
            </div>
            <button class="btn btn-dark" (click)="exportData()">
                <i class="fas fa-download"></i> T√©l√©charger les Donn√©es
            </button>
        </div>
    </div>

    </div>

  </main>
</div>
