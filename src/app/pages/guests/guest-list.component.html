<div class="guest-list">
    
    <!-- Indicateur de chargement -->
    <app-spinner [isLoading]="isLoading"></app-spinner>

    <!-- Header eventId, eventTitle-->
    <div class="guest-list-header">
        <div class="container">
            <a (click)="navigateToEventPage()" class="back-link">‚Üê Retour a l'√©v√©nement</a>
            <div class="header-content">
            <div>
                <h1>Gestion des invit√©s</h1>
                <p>{{ eventTitle }} - {{ totalGuests }} invit√©s</p>
            </div>
            <div class="header-actions">
                <button class="btn btn-outline" (click)="openAddGuestModal()">
                ‚ûï  Nouveau
                </button>
                <button class="btn btn-outline" (click)="openImportModal()">
                üì• Importer
                </button>
                <button class="btn btn-primary" (click)="sendReminder()">
                    {{ loading ? '‚è≥ Renvoie...' : '‚úâÔ∏è Envoyer rappel' }}
                </button>
            </div>
            </div>
        </div>
    </div>

    <!-- Main content -->
    <div class="container py-12">
        <!-- Search and Filter -->
        <div *ngIf="guests.length > 0" class="search-filter-section">
            <div class="search-box">
                <input
                    type="text"
                    placeholder="Rechercher par nom, email ou t√©l√©phone..."
                    [(ngModel)]="searchTerm"
                    (ngModelChange)="filterGuests()"
                    class="search-input"
                />
                <span class="search-icon">üîç</span>
            </div>

            <div class="filter-buttons">
                <button
                    *ngFor="let filter of filters"
                    [class.active]="filterStatus() === filter.value"
                    (click)="setFilterStatus(filter.value)"
                    class="filter-btn"
                >
                    {{ getFilterLabel(filter.value) }}
                    <span class="count">{{ getStatusCount(filter.value) }}</span>
                </button>
                <div class="view-controls">
                    <span class="view-label texte-desktop">Affichage :</span>
                    <div class="view-buttons">
                        <button 
                            class="view-btn"
                            [class.active]="viewMode === 'grid'"
                            (click)="setViewMode('grid')"
                            title="Affichage en grille">
                            <span class="view-icon">‚äû</span>
                            Grille
                        </button>
                        <button 
                            class="view-btn"
                            [class.active]="viewMode === 'table'"
                            (click)="setViewMode('table')"
                            title="Affichage en tableau">
                            <span class="view-icon">‚ò∞</span>
                            Tableau
                        </button>
                    </div>
                </div>
                <button
                    [disabled]="guestIdList.length === 0"
                    (click)="openDeleteModal(guestIdList, 'send')"
                    class="filter-btn send"
                    >
                    {{ loading ? '‚è≥ Envoie...' : 'Envoyer ' + guestIdList.length + ' invitation(s)' }}
                </button>
                <button
                    [disabled]="guestIdList.length === 0"
                    (click)="openDeleteModal(guestIdList, 'delete')"
                    class="filter-btn delete"
                    >
                    {{ loadingDelete ? '‚è≥ Suppression...' : 'Supprimer ' + guestIdList.length + ' invit√©(s)'}}
                </button>
            </div>
        </div>

        <!-- Guests Grid View -->
        <div *ngIf="viewMode === 'grid' && filteredGuests.length > 0" class="guests-grid">
            <div *ngFor="let guest of paginatedGuests()" class="guest-card" [class]="'status-' + guest.status">
                <!-- Card Header -->
                <div class="card-header click" (click)="goToGuestDetail(guest.id)">
                    <div class="guest-avatar">
                    {{ guest.name.charAt(0).toUpperCase() }}
                    </div>
                    <div class="guest-status">
                    <span class="status-badge" [class]="'status-' + guest.status">
                        {{ getStatusIcon(guest.status) }} {{ getStatusLabel(guest.status) }}
                    </span>
                    </div>
                </div>

                <!-- Card Body -->
                <div class="card-body click" (click)="goToGuestDetail(guest.id)">
                    <h3>{{ guest.name }}</h3>
                    <p class="guest-email">{{ guest.email }}</p>

                    <div class="guest-info">
                    <div class="info-item" *ngIf="guest.phone">
                        <span class="label">üì±</span>
                        <span class="value">{{ guest.phone }}</span>
                    </div>

                    <div class="info-item" *ngIf="guest.dietaryRestrictions">
                        <span class="label">üçΩÔ∏è</span>
                        <span class="value">{{ guest.dietaryRestrictions }}</span>
                    </div>

                    <div class="info-item" *ngIf="guest.plusOne">
                        <span class="label">üë•</span>
                        <span class="value">+1 autoris√©</span>
                    </div>

                    <div class="info-item" *ngIf="guest.responseDate">
                        <span class="label">üìÖ</span>
                        <span class="value">{{ formatDate(guest.responseDate) }}</span>
                    </div>
                    </div>

                    <!-- QR Code Badge -->
                    <div class="qr-badge" *ngIf="guest.qrCodeGenerated">
                    <span class="qr-icon">üì±</span>
                    <span class="qr-text">QR Code g√©n√©r√©</span>
                    </div>
                </div>

                <!-- Card Footer -->
                <div class="card-footer">
                    <button
                    class="btn-action view"
                    (click)="viewGuestDetails(guest)"
                    title="Voir les d√©tails"
                    >
                    üëÅÔ∏è D√©tails
                    </button>
                    <button
                    class="btn-action edit"
                    (click)="editGuest(guest)"
                    title="√âditer"
                    >
                    ‚úèÔ∏è √âditer
                    </button>
                    <button
                    class="btn-action delete"
                    (click)="openDeleteModal(guest, 'one')"
                    title="Supprimer"
                    >
                    üóëÔ∏è Supprimer
                    </button>
                </div>
            </div>
        </div>

        <!-- Guests Table View -->
        <div *ngIf="viewMode === 'table' && filteredGuests.length > 0" class="guests-grid" class="guests-table">
            <table>
                <thead>
                    <tr>
                        <th><input 
                            type="checkbox"
                            [checked]="isAllSelected"
                            (change)="toggleSelectAll($event)"
                            class="modern-checkbox"
                        /></th>
                        <th>Nom</th>
                        <th>Email</th>
                        <th>Statut</th>
                        <th>Restrictions</th>
                        <th>+1</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let guest of paginatedGuests()" [ngClass]="'status-' + guest.status">
                        <td>  
                           <input
                            type="checkbox"
                            [checked]="guestIdList.includes(guest.id)"
                            (change)="onGuestSelected(guest, $event)"
                            class="modern-checkbox"
                            />
                        </td>
                        <td>{{ guest.name }}</td>
                        <td class="email">{{ guest.email }}</td>
                        <td>
                        <span class="status-badge" [class]="'status-' + guest.status">
                            {{ getStatusIcon(guest.status) }} {{ getStatusLabel(guest.status) }}
                        </span>
                        </td>
                        <td class="restrictions">{{ guest.dietaryRestrictions || '-' }}</td>
                        <td class="center">{{ guest.plusOne ? '‚úì' : '-' }}</td>
                        <td class="actions action-width">
                        <button class="btn-small" (click)="viewGuestDetails(guest)">Envoyer invitation</button>
                        <button class="btn-small-delete" (click)="openDeleteModal(guest, 'one')">Supprimer</button>
                        </td>
                    </tr>
                </tbody>
            </table>
            <div *ngIf="filteredGuests.length === 0" class="no-guests">
                <p>Aucun invit√© trouv√©</p>
            </div>
        </div>

        <!-- Pagination Controls -->
        <div *ngIf="guests.length > 0" class="pagination">
            <button 
                (click)="prevPage()" 
                [disabled]="currentPage === 1"
                class="page-btn">
                ‚óÄ
            </button>

            <button 
                *ngFor="let page of totalPagesArray()" 
                (click)="goToPage(page)"
                [class.active]="page === currentPage"
                class="page-btn">
                {{ page }}
            </button>

            <button 
                (click)="nextPage()" 
                [disabled]="currentPage === totalPages"
                class="page-btn">
                ‚ñ∂
            </button>
        </div>
        <!-- END Guests Table View -->

        <!-- Empty State -->
        <div *ngIf="filteredGuests.length === 0" class="empty-state">
            <div class="empty-icon">üë•</div>
            <h3>Aucun invit√© trouv√©</h3>
            <p>Essayez de modifier vos filtres ou invitez de nouveaux invit√©s</p>
            <button class="btn btn-primary" (click)="openAddGuestModal()">
            ‚úâÔ∏è Inviter des invit√©s
            </button>
        </div>

        <!-- Stats Footer -->
        <div class="stats-footer">
            <div class="stat">
                <span class="label">Total</span>
                <span class="value">{{ totalGuests }}</span>
            </div>
            <div class="stat confirmed">
                <span class="label">Confirm√©s</span>
                <span class="value">{{ confirmedCount }}</span>
            </div>
            <div class="stat pending">
                <span class="label">En attente</span>
                <span class="value">{{ pendingCount }}</span>
            </div>
            <div class="stat declined">
                <span class="label">Refus√©s</span>
                <span class="value">{{ declinedCount }}</span>
            </div>
        </div>
    </div>

    <!-- Guest Detail Modal -->
    <div *ngIf="selectedGuest() as guest" class="modal-overlay" (click)="closeGuestDetails()">
        <div class="modal-content" (click)="$event.stopPropagation()">
            <!-- Indicateur de chargement -->
            <app-spinner [isLoading]="isModalLoading"></app-spinner>
            <button class="modal-close" (click)="closeGuestDetails()">‚úï</button>

            <div class="modal-body">
                <!-- Guest Avatar and Name -->
                <div class="modal-header">
                    <div class="large-avatar">
                    {{ guest.name.charAt(0).toUpperCase() }}
                    </div>
                    <div>
                    <h2>{{ guest.name }}</h2>
                    <p class="email">{{ guest.email }}</p>
                    </div>
                </div>

                <!-- Status Badge -->
                <div class="status-section">
                    <span class="status-badge large" [class]="'status-' + guest.status">
                    {{ getStatusIcon(guest.status) }} {{ getStatusLabel(guest.status) }}
                    </span>
                </div>

                <!-- QR Code Section -->
                <div class="qr-section" *ngIf="guest.qrCodeGenerated; else noQr">
                    <h3>Code QR</h3>
                    <div class="qr-code-container">
                    <img [src]="guest.qrCodeUrl" alt="QR Code" class="qr-code-image" />
                    <p class="qr-description">Scannez ce code pour acc√©der √† l'invitation</p>
                    </div>
                    <button class="btn btn-outline" (click)="downloadQRCode()">üì• T√©l√©charger le QR Code</button>
                </div>

                <ng-template #noQr>
                    <div class="no-qr-section">
                    <div class="no-qr-icon">üì±</div>
                    <p>Aucune invitation (code QR) g√©n√©r√© pour cet invit√©</p>
                    <button class="btn btn-primary" (click)="generateQRCode(guest.id)">‚ú® Envoyer une invitation</button>
                    </div>
                </ng-template>

                <!-- Actions -->
                <div class="modal-actions">
                    <button class="btn btn-outline" (click)="closeGuestDetails()">Fermer</button>
                    <button class="btn btn-primary" 
                    (click)="deleteInvitationFromModal(guest)" 
                    [disabled]="guest.qrCodeGenerated && !loadingDelete ? false : true">
                    {{loadingDelete ? '‚è≥ Suppression...' : 'üóëÔ∏è Supprimer'}}</button>
                </div>
            </div>
        </div>
    </div>
</div>
<div>
    <!-- Add Guest Modal -->
    <app-add-guest-modal
        *ngIf="showAddGuestModal()"
        (guestAdded)="onGuestAdded($event)"
        (closed)="closeAddGuestModal()"
    ></app-add-guest-modal>

    <app-error-modal
        [visible]="showErrorModal"
        [message]="errorMessage"
        (closed)="closeErrorModal()">
    </app-error-modal>

    <!-- Import Guests Modal -->
    <app-import-guests-modal
        *ngIf="showImportModal()"
        (refresh)="getGuestsByEvent()"
        (closed)="closeImportModal()"
    ></app-import-guests-modal>

    <!-- Modal de confirmation -->
    <app-confirm-delete-modal
        [visible]="showDeleteModal"
        [message] = warningMessage
        [action]="modalAction"
        (confirmDelete)="confirmDelete()"
        (confirmSend)="sendInvitation()"
        (cancel)="closeModal()">
    </app-confirm-delete-modal>
</div>
